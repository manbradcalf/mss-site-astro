<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NFL PageRank Analysis</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #f0f1f5;
        color: #1a1a2e;
        min-height: 100vh;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        text-align: center;
        padding: 30px 0;
        border-bottom: 2px solid #dcdde3;
        margin-bottom: 30px;
      }
      h1 {
        font-size: 2.5rem;
        color: #111827;
        margin-bottom: 10px;
      }
      .subtitle {
        color: #555e70;
        font-size: 1.1rem;
      }
      .controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }
      .control-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      label {
        font-weight: 600;
        color: #374151;
      }
      select {
        padding: 10px 20px;
        font-size: 1rem;
        border: 1px solid #c4c7d0;
        border-radius: 8px;
        background: #fff;
        color: #1a1a2e;
        cursor: pointer;
        transition: all 0.3s;
      }
      select:hover {
        border-color: #8b90a0;
      }
      select:focus {
        outline: 2px solid #3b5bdb;
        outline-offset: 1px;
      }
      .main-content {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 30px;
      }
      @media (max-width: 1000px) {
        .main-content {
          grid-template-columns: 1fr;
        }
      }
      .graph-container {
        background: #1e2235;
        border-radius: 16px;
        padding: 20px;
        position: relative;
        min-height: 600px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.12);
      }
      .graph-title {
        font-size: 1.3rem;
        margin-bottom: 15px;
        color: #e8e9ed;
        font-weight: 600;
      }
      #graph {
        width: 100%;
        height: 550px;
        border-radius: 12px;
        background: #252a3a;
      }
      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .panel {
        background: #fff;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        border: 1px solid #e0e1e6;
      }
      .panel-title {
        font-size: 1.1rem;
        margin-bottom: 15px;
        color: #111827;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .rankings-list {
        max-height: 300px;
        overflow-y: auto;
      }
      .rank-item {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        margin-bottom: 4px;
        border-radius: 8px;
        background: #f5f6fa;
        transition: all 0.2s;
        cursor: pointer;
      }
      .rank-item:hover {
        background: #e8eaf0;
        transform: translateX(5px);
      }
      .rank-item.sb-team {
        border-left: 3px solid #b8860b;
        background: #fdf8ec;
      }
      .rank-num {
        width: 30px;
        font-weight: bold;
        color: #6b7280;
      }
      .team-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 10px;
      }
      .team-name {
        flex: 1;
        font-weight: 500;
        color: #1a1a2e;
      }
      .team-score {
        font-size: 0.85rem;
        color: #6b7280;
        font-weight: 500;
      }
      .sb-info {
        padding: 15px;
        background: #fdf8ec;
        border-radius: 12px;
        border: 1px solid #e0c868;
      }
      .sb-matchup {
        font-size: 1.5rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
      }
      .sb-details {
        display: flex;
        flex-direction: column;
        gap: 0;
      }
      .sb-detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f0e8d0;
      }
      .sb-detail-row:last-of-type {
        border-bottom: none;
      }
      .sb-detail-label {
        font-weight: 600;
        color: #6b7280;
        font-size: 0.85rem;
        white-space: nowrap;
        margin-right: 10px;
      }
      .prediction-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: bold;
        margin-top: 10px;
      }
      .prediction-badge.correct {
        background: #16a34a;
        color: #fff;
      }
      .prediction-badge.incorrect {
        background: #dc2626;
        color: #fff;
      }
      .prediction-badge.pending {
        background: #d97706;
        color: #fff;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 30px;
      }
      @media (max-width: 500px) {
        .stats-grid {
          grid-template-columns: 1fr;
          gap: 10px;
        }
        .stat-value {
          font-size: 1.5rem;
        }
        .container {
          padding: 10px;
        }
        .history-table th,
        .history-table td {
          padding: 8px 4px;
          font-size: 0.75rem;
        }
        .team-badge {
          padding: 1px 5px !important;
          font-size: 0.7rem !important;
        }
      }
      .stat-card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        border: 1px solid #e0e1e6;
      }
      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #111827;
      }
      .stat-label {
        font-size: 0.9rem;
        color: #6b7280;
        margin-top: 5px;
        font-weight: 500;
      }
      .tooltip {
        position: absolute;
        background: #1a1c24;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        padding: 12px;
        pointer-events: none;
        z-index: 100;
        font-size: 0.9rem;
        max-width: 200px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        color: #ddd;
      }
      .tooltip-title {
        font-weight: bold;
        margin-bottom: 5px;
      }
      .legend {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-top: 15px;
        flex-wrap: wrap;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        color: #c4c7d0;
      }
      .legend-line {
        width: 30px;
        height: 2px;
      }
      .history-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 30px;
      }
      .history-table th,
      .history-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e1e6;
      }
      .history-table th {
        background: #f0f1f5;
        font-weight: 600;
        color: #374151;
      }
      .history-table td {
        color: #1a1a2e;
      }
      .history-table tr:hover {
        background: #f5f6fa;
      }
      .matchup-cell {
        display: inline-flex;
        flex-direction: column;
        gap: 2px;
      }
      .matchup-row {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .matchup-rank {
        color: #6b7280;
        font-size: 0.8rem;
        font-weight: 500;
        min-width: 24px;
      }
      .matchup-vs {
        font-size: 0.7rem;
        color: #9ca3af;
        padding-left: 2px;
      }
      .node-label {
        font-size: 10px;
        font-weight: bold;
        text-anchor: middle;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>NFL PageRank Analysis</h1>
        <p class="subtitle">Ranking NFL teams using Google's PageRank algorithm â€” 25 seasons of data</p>
      </header>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="accuracy">--%</div>
          <div class="stat-label">Overall Accuracy</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="correct-count">--/--</div>
          <div class="stat-label">Correct Predictions</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="seasons-count">--</div>
          <div class="stat-label">Seasons Analyzed</div>
        </div>
      </div>

      <div class="controls">
        <div class="control-group">
          <label for="mode-select">Games:</label>
          <select id="mode-select">
            <option value="reg">Regular Season Only</option>
            <option value="playoffs">Reg + Playoffs (thru Conf)</option>
          </select>
        </div>
        <div class="control-group">
          <label for="season-select">Season:</label>
          <select id="season-select"></select>
        </div>
      </div>

      <div class="main-content">
        <div class="graph-container">
          <h3 class="graph-title">Team Strength Network</h3>
          <div id="graph"></div>
          <div class="legend">
            <div class="legend-item">
              <div
                class="legend-line"
                style="background: rgba(255, 255, 255, 0.4)"
              ></div>
              <span>Game Result (arrow points to winner)</span>
            </div>
            <div class="legend-item">
              <svg width="20" height="20">
                <circle cx="10" cy="10" r="8" fill="#4facfe" />
              </svg>
              <span>Node size = PageRank score</span>
            </div>
          </div>
        </div>

        <div class="sidebar">
          <div class="panel">
            <h3 class="panel-title" id="sb-panel-title">PageRank's Super Bowl Prediction</h3>
            <div class="sb-info" id="sb-info">
              <div class="sb-matchup" id="sb-matchup">-</div>
              <div class="sb-details" id="sb-details"></div>
            </div>
          </div>

          <div class="panel">
            <h3 class="panel-title">PageRank Rankings</h3>
            <div class="rankings-list" id="rankings-list"></div>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top: 30px">
        <h3 class="panel-title">Prediction History</h3>
        <div style="overflow-x: auto">
        <table class="history-table" id="history-table">
          <thead>
            <tr>
              <th>Season</th>
              <th>Matchup</th>
              <th>PageRank Pick</th>
              <th>Actual Winner</th>
              <th>Result</th>
            </tr>
          </thead>
          <tbody id="history-body"></tbody>
        </table>
        </div>
      </div>
    </div>

    <div class="tooltip" id="tooltip" style="display: none"></div>

    <script>
      // NFL Team Colors
      const TEAM_COLORS = {
        ARI: "#97233F",
        ATL: "#A71930",
        BAL: "#241773",
        BUF: "#00338D",
        CAR: "#0085CA",
        CHI: "#0B162A",
        CIN: "#FB4F14",
        CLE: "#311D00",
        DAL: "#003594",
        DEN: "#FB4F14",
        DET: "#0076B6",
        GB: "#203731",
        HOU: "#03202F",
        IND: "#002C5F",
        JAX: "#006778",
        KC: "#E31837",
        LA: "#003594",
        LAC: "#0080C6",
        LV: "#000000",
        MIA: "#008E97",
        MIN: "#4F2683",
        NE: "#002244",
        NO: "#D3BC8D",
        NYG: "#0B2265",
        NYJ: "#125740",
        OAK: "#000000",
        PHI: "#004C54",
        PIT: "#FFB612",
        SEA: "#002244",
        SF: "#AA0000",
        STL: "#002244",
        TB: "#D50A0A",
        TEN: "#0C2340",
        WAS: "#773141",
        LAR: "#003594",
        SD: "#0080C6",
      };

      const TEAM_NAMES = {
        ARI: "Cardinals",
        ATL: "Falcons",
        BAL: "Ravens",
        BUF: "Bills",
        CAR: "Panthers",
        CHI: "Bears",
        CIN: "Bengals",
        CLE: "Browns",
        DAL: "Cowboys",
        DEN: "Broncos",
        DET: "Lions",
        GB: "Packers",
        HOU: "Texans",
        IND: "Colts",
        JAX: "Jaguars",
        KC: "Chiefs",
        LA: "Rams",
        LAC: "Chargers",
        LV: "Raiders",
        MIA: "Dolphins",
        MIN: "Vikings",
        NE: "Patriots",
        NO: "Saints",
        NYG: "Giants",
        NYJ: "Jets",
        OAK: "Raiders",
        PHI: "Eagles",
        PIT: "Steelers",
        SEA: "Seahawks",
        SF: "49ers",
        STL: "Rams",
        TB: "Buccaneers",
        TEN: "Titans",
        WAS: "Commanders",
        LAR: "Rams",
        SD: "Chargers",
      };

      // Super Bowl scores: [winner_score, loser_score]
      // team1 in superBowls data is always the winner
      const SUPER_BOWL_SCORES = {
        "2001": [20, 17],
        "2002": [48, 21],
        "2003": [32, 29],
        "2004": [24, 21],
        "2005": [21, 10],
        "2006": [29, 17],
        "2007": [17, 14],
        "2008": [27, 23],
        "2009": [31, 17],
        "2010": [31, 25],
        "2011": [21, 17],
        "2012": [34, 31],
        "2013": [43, 8],
        "2014": [28, 24],
        "2015": [24, 10],
        "2016": [34, 28],
        "2017": [41, 33],
        "2018": [13, 3],
        "2019": [31, 20],
        "2020": [31, 9],
        "2021": [23, 20],
        "2022": [38, 35],
        "2023": [25, 22],
        "2024": [40, 22],
      };

      // Darken light team colors so they're readable as text on light backgrounds
      function lightTeamColor(team) {
        const hex = TEAM_COLORS[team] || "#666";
        let r = parseInt(hex.slice(1, 3), 16),
          g = parseInt(hex.slice(3, 5), 16),
          b = parseInt(hex.slice(5, 7), 16);
        const lum = 0.299 * r + 0.587 * g + 0.114 * b;
        if (lum > 160) {
          r = Math.round(r * 0.6);
          g = Math.round(g * 0.6);
          b = Math.round(b * 0.6);
        }
        return `rgb(${r},${g},${b})`;
      }

      // Brighten dark team colors for use on dark backgrounds (tooltips)
      function brightTeamColor(team) {
        const hex = TEAM_COLORS[team] || "#666";
        let r = parseInt(hex.slice(1, 3), 16),
          g = parseInt(hex.slice(3, 5), 16),
          b = parseInt(hex.slice(5, 7), 16);
        const lum = 0.299 * r + 0.587 * g + 0.114 * b;
        if (lum < 100) {
          const boost = 1.8;
          r = Math.min(255, Math.round(r * boost + 80));
          g = Math.min(255, Math.round(g * boost + 80));
          b = Math.min(255, Math.round(b * boost + 80));
        }
        return `rgb(${r},${g},${b})`;
      }

      // Pick white or black text for a given team circle
      function labelColor(team) {
        const hex = TEAM_COLORS[team] || "#666";
        const r = parseInt(hex.slice(1, 3), 16),
          g = parseInt(hex.slice(3, 5), 16),
          b = parseInt(hex.slice(5, 7), 16);
        return 0.299 * r + 0.587 * g + 0.114 * b > 140 ? "#000" : "#fff";
      }

      function teamBadge(team) {
        const bg = TEAM_COLORS[team] || "#666";
        return `<span class="team-badge" style="display:inline-block;padding:2px 8px;border-radius:4px;background:${bg};color:${labelColor(team)};font-weight:600;font-size:0.85rem;white-space:nowrap">${team}</span>`;
      }

      let data = null;
      let simulation = null;
      let currentMode = "reg";

      function getSeasons() {
        return data[currentMode].seasons;
      }

      async function loadData() {
        try {
          const response = await fetch("pagerank_data.json");
          data = await response.json();

          // Support old format (flat seasons) and new format (reg/playoffs)
          if (data.seasons && !data.reg) {
            data = {
              reg: { seasons: data.seasons },
              playoffs: { seasons: data.seasons },
              superBowls: data.superBowls,
            };
          }

          initApp();
        } catch (e) {
          console.error("Failed to load data:", e);
          document.body.innerHTML =
            '<div style="padding:50px;text-align:center;color:#b91c1c;"><h2>Failed to load data</h2><p>Run export_data.py first to generate pagerank_data.json</p></div>';
        }
      }

      function initApp() {
        const modeSelect = document.getElementById("mode-select");
        const seasonSelect = document.getElementById("season-select");

        populateSeasons();

        modeSelect.addEventListener("change", () => {
          currentMode = modeSelect.value;
          const prevSeason = seasonSelect.value;
          populateSeasons();
          if (getSeasons()[prevSeason]) {
            seasonSelect.value = prevSeason;
          }
          updateStats();
          updateHistory();
          updateSeason(seasonSelect.value);
        });

        seasonSelect.addEventListener("change", () =>
          updateSeason(seasonSelect.value),
        );

        updateStats();
        updateHistory();
        updateSeason(seasonSelect.value);
      }

      function populateSeasons() {
        const select = document.getElementById("season-select");
        const seasons = Object.keys(getSeasons()).sort((a, b) => b - a);
        select.innerHTML = "";

        seasons.forEach((season) => {
          const opt = document.createElement("option");
          opt.value = season;
          opt.textContent = `${season} Season`;
          select.appendChild(opt);
        });
      }

      function updateStats() {
        let correct = 0;
        let total = 0;
        const seasons = getSeasons();

        Object.entries(data.superBowls).forEach(
          ([season, [team1, team2, winner]]) => {
            if (!winner || !seasons[season]) return;

            const nodes = seasons[season].nodes;
            const t1 = nodes.find((n) => n.team === team1);
            const t2 = nodes.find((n) => n.team === team2);

            if (t1 && t2) {
              const pick = t1.score > t2.score ? team1 : team2;
              if (pick === winner) correct++;
              total++;
            }
          },
        );

        document.getElementById("accuracy").textContent =
          `${Math.round((100 * correct) / total)}%`;
        document.getElementById("correct-count").textContent =
          `${correct}/${total}`;
        document.getElementById("seasons-count").textContent =
          Object.keys(seasons).length;
      }

      function updateHistory() {
        const tbody = document.getElementById("history-body");
        tbody.innerHTML = "";
        const seasons = getSeasons();

        Object.entries(data.superBowls)
          .sort((a, b) => b[0] - a[0])
          .forEach(([season, [team1, team2, winner]]) => {
            if (!seasons[season]) return;

            const nodes = seasons[season].nodes;
            const t1 = nodes.find((n) => n.team === team1);
            const t2 = nodes.find((n) => n.team === team2);

            if (!t1 || !t2) return;

            const pick = t1.score > t2.score ? team1 : team2;
            const isCorrect = winner ? pick === winner : null;

            const tr = document.createElement("tr");
            tr.innerHTML = `
                        <td>${season}</td>
                        <td><div class="matchup-cell">
                          <div class="matchup-row">${teamBadge(team1)}<span class="matchup-rank">#${t1.rank}</span></div>
                          <div class="matchup-vs">vs</div>
                          <div class="matchup-row">${teamBadge(team2)}<span class="matchup-rank">#${t2.rank}</span></div>
                        </div></td>
                        <td>${teamBadge(pick)}</td>
                        <td>${winner ? teamBadge(winner) : "TBD"}</td>
                        <td>${
                          isCorrect === null
                            ? '<span style="color:#b45309;font-weight:600">Pending</span>'
                            : isCorrect
                              ? '<span style="color:#15803d;font-weight:600">Correct</span>'
                              : '<span style="color:#b91c1c;font-weight:600">Wrong</span>'
                        }</td>
                    `;
            tr.style.cursor = "pointer";
            tr.addEventListener("click", () => {
              document.getElementById("season-select").value = season;
              updateSeason(season);
              window.scrollTo({ top: 0, behavior: "smooth" });
            });
            tbody.appendChild(tr);
          });
      }

      function updateSeason(season) {
        const seasonData = getSeasons()[season];
        if (!seasonData) return;

        updateRankings(season, seasonData);
        updateSBInfo(season, seasonData);
        updateGraph(season, seasonData);
      }

      function updateRankings(season, seasonData) {
        const list = document.getElementById("rankings-list");
        const sb = data.superBowls[season] || [];

        list.innerHTML = seasonData.nodes
          .map((node) => {
            const isSBTeam = sb.includes(node.team);
            return `
                    <div class="rank-item ${isSBTeam ? "sb-team" : ""}" data-team="${node.team}">
                        <span class="rank-num">#${node.rank}</span>
                        <span class="team-dot" style="background:${TEAM_COLORS[node.team] || "#666"}"></span>
                        <span class="team-name">${node.team}</span>
                        <span class="team-score">${node.score.toFixed(3)}</span>
                    </div>
                `;
          })
          .join("");

        list.querySelectorAll(".rank-item").forEach((item) => {
          item.addEventListener("mouseenter", () =>
            highlightTeam(item.dataset.team, true),
          );
          item.addEventListener("mouseleave", () =>
            highlightTeam(item.dataset.team, false),
          );
        });
      }

      function updateSBInfo(season, seasonData) {
        const [team1, team2, winner] = data.superBowls[season] || [];

        if (!team1 || !team2) {
          document.getElementById("sb-panel-title").textContent =
            "PageRank's Super Bowl Prediction";
          document.getElementById("sb-matchup").textContent =
            "No Super Bowl Data";
          document.getElementById("sb-details").innerHTML = "";
          return;
        }

        const t1 = seasonData.nodes.find((n) => n.team === team1);
        const t2 = seasonData.nodes.find((n) => n.team === team2);
        const pick = t1 && t2 ? (t1.score > t2.score ? team1 : team2) : null;
        const pickNode = pick === team1 ? t1 : t2;
        const scores = SUPER_BOWL_SCORES[season];
        const isCorrect = winner ? pick === winner : null;
        const loser = winner === team1 ? team2 : team1;
        const pickName = TEAM_NAMES[pick] || pick;

        document.getElementById("sb-panel-title").innerHTML =
          `PageRank picks the ${teamBadge(pick)} ${pickName}`;

        document.getElementById("sb-matchup").innerHTML = `
                <span style="color:${lightTeamColor(team1)}">${team1}</span>
                <span style="font-weight:400;color:#6b7280">vs</span>
                <span style="color:${lightTeamColor(team2)}">${team2}</span>
            `;

        let resultHTML;
        if (winner && scores) {
          resultHTML = `${teamBadge(winner)} <span style="font-weight:600">${scores[0]}</span> - <span style="font-weight:600">${scores[1]}</span> ${teamBadge(loser)}`;
        } else {
          resultHTML = '<span style="color:#9ca3af;font-style:italic">TBD</span>';
        }

        let badgeClass = "pending";
        let badgeText = "Pending";
        if (isCorrect === true) {
          badgeClass = "correct";
          badgeText = "Correct";
        } else if (isCorrect === false) {
          badgeClass = "incorrect";
          badgeText = "Wrong";
        }

        document.getElementById("sb-details").innerHTML = `
                <div class="sb-detail-row">
                    <span class="sb-detail-label">PageRank Pick</span>
                    <span>${teamBadge(pick)} <span style="color:#6b7280;font-size:0.85rem">#${pickNode?.rank || "?"} (${pickNode?.score.toFixed(3) || "-"})</span></span>
                </div>
                <div class="sb-detail-row">
                    <span class="sb-detail-label">Result</span>
                    <span>${resultHTML}</span>
                </div>
                <div style="text-align:center;margin-top:8px">
                    <span class="prediction-badge ${badgeClass}">${badgeText}</span>
                </div>
            `;
      }

      function updateGraph(season, seasonData) {
        const container = document.getElementById("graph");
        container.innerHTML = "";

        const width = container.clientWidth;
        const height = container.clientHeight;

        const svg = d3
          .select(container)
          .append("svg")
          .attr("width", width)
          .attr("height", height);

        // Create arrow marker
        svg
          .append("defs")
          .append("marker")
          .attr("id", "arrow")
          .attr("viewBox", "0 -5 10 10")
          .attr("refX", 20)
          .attr("refY", 0)
          .attr("markerWidth", 6)
          .attr("markerHeight", 6)
          .attr("orient", "auto")
          .append("path")
          .attr("d", "M0,-5L10,0L0,5")
          .attr("fill", "rgba(255,255,255,0.25)");

        const nodes = seasonData.nodes.map((n) => ({
          ...n,
          id: n.team,
          radius: 8 + n.score * 8,
        }));

        const nodeMap = new Map(nodes.map((n) => [n.team, n]));

        // Aggregate edges (sum margins for multiple games)
        const edgeMap = new Map();
        seasonData.edges.forEach((e) => {
          const key = `${e.source}-${e.target}`;
          if (edgeMap.has(key)) {
            edgeMap.get(key).margin += e.margin;
          } else {
            edgeMap.set(key, { ...e });
          }
        });

        const links = Array.from(edgeMap.values())
          .filter((e) => nodeMap.has(e.source) && nodeMap.has(e.target))
          .map((e) => ({
            source: e.source,
            target: e.target,
            margin: e.margin,
          }));

        if (simulation) simulation.stop();

        simulation = d3
          .forceSimulation(nodes)
          .force(
            "link",
            d3
              .forceLink(links)
              .id((d) => d.id)
              .distance(80),
          )
          .force("charge", d3.forceManyBody().strength(-200))
          .force("center", d3.forceCenter(width / 2, height / 2))
          .force(
            "collision",
            d3.forceCollide().radius((d) => d.radius + 5),
          );

        const link = svg
          .append("g")
          .selectAll("line")
          .data(links)
          .join("line")
          .attr("stroke", "rgba(255,255,255,0.12)")
          .attr("stroke-width", (d) => Math.min(d.margin / 20, 3))
          .attr("marker-end", "url(#arrow)");

        const node = svg
          .append("g")
          .selectAll("g")
          .data(nodes)
          .join("g")
          .attr("class", "node-group")
          .call(
            d3
              .drag()
              .on("start", dragstarted)
              .on("drag", dragged)
              .on("end", dragended),
          );

        node
          .append("circle")
          .attr("r", (d) => d.radius)
          .attr("fill", (d) => TEAM_COLORS[d.team] || "#666")
          .attr("stroke", (d) => {
            const c = TEAM_COLORS[d.team] || "#666";
            // Give dark teams a visible border on light background
            const r = parseInt(c.slice(1, 3), 16),
              g = parseInt(c.slice(3, 5), 16),
              b = parseInt(c.slice(5, 7), 16);
            return r + g + b < 150 ? "#999" : "#fff";
          })
          .attr("stroke-width", 2)
          .style("cursor", "pointer");

        node
          .append("text")
          .attr("class", "node-label")
          .attr("dy", 3)
          .attr("fill", (d) => labelColor(d.team))
          .text((d) => d.team);

        const tooltip = document.getElementById("tooltip");

        node
          .on("mouseenter", (event, d) => {
            // Always use regular season edges for record display
            const regEdges = data.reg.seasons[season]?.edges || seasonData.edges;
            const wins = regEdges.filter(
              (e) => e.target === d.team,
            ).length;
            const losses = regEdges.filter(
              (e) => e.source === d.team,
            ).length;

            tooltip.innerHTML = `
                    <div class="tooltip-title" style="color:${brightTeamColor(d.team)}">${d.team} ${TEAM_NAMES[d.team] || ""}</div>
                    <div>Rank: #${d.rank}</div>
                    <div>PageRank: ${d.score.toFixed(4)}</div>
                    <div>Record: ${wins}-${losses}</div>
                `;
            tooltip.style.display = "block";
            tooltip.style.left = event.pageX + 10 + "px";
            tooltip.style.top = event.pageY + 10 + "px";

            highlightTeam(d.team, true);
          })
          .on("mousemove", (event) => {
            tooltip.style.left = event.pageX + 10 + "px";
            tooltip.style.top = event.pageY + 10 + "px";
          })
          .on("mouseleave", (event, d) => {
            tooltip.style.display = "none";
            highlightTeam(d.team, false);
          });

        simulation.on("tick", () => {
          link
            .attr("x1", (d) => d.source.x)
            .attr("y1", (d) => d.source.y)
            .attr("x2", (d) => d.target.x)
            .attr("y2", (d) => d.target.y);

          node.attr("transform", (d) => `translate(${d.x},${d.y})`);
        });

        function dragstarted(event, d) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        }

        function dragged(event, d) {
          d.fx = event.x;
          d.fy = event.y;
        }

        function dragended(event, d) {
          if (!event.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        }
      }

      function highlightTeam(team, highlight) {
        d3.selectAll(".node-group").style("opacity", (d) =>
          highlight ? (d.team === team ? 1 : 0.3) : 1,
        );

        d3.selectAll("line")
          .style("opacity", (d) => {
            if (!highlight) return 1;
            return d.source.id === team || d.target.id === team ? 1 : 0.1;
          })
          .style("stroke", (d) => {
            if (!highlight) return "rgba(255,255,255,0.12)";
            if (d.target.id === team) return "#2e7d32";
            if (d.source.id === team) return "#c62828";
            return "rgba(255,255,255,0.12)";
          });
      }

      loadData();
    </script>
  </body>
</html>
